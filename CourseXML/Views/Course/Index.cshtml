@model CityOffice

<img src="/images/logo.png" class="background-logo" alt="Логотип">

<body>
    <div class="content-wrapper">
        <div class="header">
            <div class="header-left">
                <div class="bank-name">АО Тольяттихимбанк</div>
                <div class="office-text">@Model.Location</div>
            </div>
            <div class="time-card">
                <div class="time-value" id="currentDateTime">@DateTime.Now.ToString($"dd.MM.yyyy HH:mm:ss")</div>
            </div>
        </div>

        <div class="table-container">
            <!-- Таблица -->
            <table class="currency-table">
                <thead>
                    <tr>
                        <th>Валюта</th>
                        <th>Покупка</th>
                        <th>Продажа</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var currency in Model.Currencies)
                    {
                        <tr data-currency="@currency.Name">
                            <td>
                                <div class="currency-name">
                                    <div class="flag" style="background-image: url('/images/@(currency.Name).png')"></div>
                                    <span class="currency-code">@currency.Name</span>
                                </div>
                            </td>
                            <td>
                                <div class="rate-value purchase">@currency.Purchase.ToString("N2")</div>
                            </td>
                            <td>
                                <div class="rate-value sale">@currency.Sale.ToString("N2")</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</body>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const officeId = '@Model.Id'.toLowerCase();
        let connection = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 20;
        let isManualDisconnect = false;
        let lastUpdateTime = Date.now();

        // Обновление времени
        function updateDateTime() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('currentDateTime').textContent =
                `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;

            setTimeout(updateDateTime, 1000);
        }

        async function startSignalR() {
            try {
                console.log('Начинаем подключение SignalR...');

                // Если уже есть активное соединение, не создаем новое
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    console.log('Уже подключен');
                    return;
                }

                // Если есть старое соединение, закрываем его
                if (connection) {
                    try {
                        await connection.stop();
                        console.log('Старое соединение закрыто');
                    } catch (e) {
                        console.warn('Ошибка при закрытии старого соединения:', e);
                    }
                }

                // Создаем новое соединение
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/currencyHub")
                    .withAutomaticReconnect({
                        nextRetryDelayInMilliseconds: retryContext => {
                            // Умная логика повторного подключения
                            reconnectAttempts++;
                            console.log(`Попытка повторного подключения ${reconnectAttempts}/20`);

                            if (reconnectAttempts > maxReconnectAttempts) {
                                console.error('Превышено максимальное количество попыток подключения');
                                return null; // Останавливаем попытки
                            }

                            // Увеличиваем интервалы между попытками
                            if (retryContext.previousRetryCount === 0) {
                                return 1000; // 1 секунда
                            } else if (retryContext.previousRetryCount < 3) {
                                return 3000; // 3 секунды
                            } else if (retryContext.previousRetryCount < 5) {
                                return 5000; // 5 секунд
                            } else {
                                return 10000; // 10 секунд
                            }
                        }
                    })
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                // === ОБРАБОТЧИКИ СОБЫТИЙ ===

                // Подтверждение подключения к группе
                connection.on("JoinedGroup", (groupId) => {
                    console.log(`Присоединен к группе: ${groupId}`);
                    reconnectAttempts = 0; // Сбрасываем счетчик при успешном подключении
                });

                // Получение обновления курсов
                connection.on("ReceiveUpdate", function(officeData) {
                    if (!officeData || !officeData.Currencies) {
                        console.warn('Получены некорректные данные');
                        return;
                    }

                    console.log('Получено обновление курсов:', officeData.UpdateTime);
                    lastUpdateTime = Date.now();

                    // Обновляем курсы валют
                    officeData.Currencies.forEach(currency => {
                        const row = document.querySelector(`tr[data-currency="${currency.Name}"]`);
                        if (row) {
                            updateCurrencyValue(row.querySelector('.purchase'), currency.Purchase);
                            updateCurrencyValue(row.querySelector('.sale'), currency.Sale);
                        }
                    });
                });

                // Keep-alive от сервера
                connection.on("KeepAlive", (timestamp) => {
                    console.log('Keep-alive получен:', new Date(timestamp).toLocaleTimeString());
                });

                // Обработка переподключения
                connection.onreconnecting((error) => {
                    console.log('Переподключение SignalR...', error?.message || '');
                });

                connection.onreconnected((connectionId) => {
                    console.log('Переподключение успешно! ID:', connectionId);
                    joinOfficeGroup();
                    reconnectAttempts = 0;
                });

                connection.onclose((error) => {
                    console.log('Соединение закрыто', error?.message || '');

                    if (!isManualDisconnect && reconnectAttempts < maxReconnectAttempts) {
                        console.log('Пытаемся переподключиться...');
                        setTimeout(() => {
                            if (connection.state === signalR.HubConnectionState.Disconnected) {
                                startSignalR();
                            }
                        }, 2000);
                    }
                });

                await connection.start();
                console.log('SignalR подключен!');

                await joinOfficeGroup();

                startConnectionMonitor();

            } catch (err) {
                console.error('Ошибка подключения SignalR:', err);

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Повторная попытка через 3 секунды (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(startSignalR, 3000);
                } else {
                    console.error('Превышено максимальное количество попыток подключения');
                    alert('Не удалось подключиться к серверу. Пожалуйста, обновите страницу.');
                }
            }
        }

        async function joinOfficeGroup() {
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                console.warn('Не могу войти в группу: нет соединения');
                return;
            }

            try {
                await connection.invoke("JoinOfficeGroup", officeId);
                console.log(`Запрос на присоединение к группе ${officeId} отправлен`);
            } catch (err) {
                console.error('Ошибка при входе в группу:', err);
                setTimeout(joinOfficeGroup, 2000);
            }
        }

        // Мониторинг соединения
        function startConnectionMonitor() {
            setInterval(() => {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    // Проверяем, когда было последнее обновление
                    const timeSinceLastUpdate = Date.now() - lastUpdateTime;
                    if (timeSinceLastUpdate > 120000) { // 2 минуты без обновлений
                        console.log('Долго не было обновлений, проверяем соединение...');
                        if (connection.state === signalR.HubConnectionState.Connected) {
                            connection.invoke("Ping")
                                .then(response => console.log('Ping ответ:', response))
                                .catch(err => {
                                    console.warn('Ping не прошел:', err);
                                    startSignalR();
                                });
                        }
                    }
                }
            }, 30000); // Каждые 30 секунд
        }

        // ОБНОВЛЕНИЕ КУРСОВ С АНИМАЦИЕЙ
        function updateCurrencyValue(element, newValue) {
            if (!element) return;

            const oldValue = parseFloat(element.textContent.replace(',', '.'));
            const numericNewValue = parseFloat(newValue);

            if (isNaN(oldValue) || isNaN(numericNewValue) || oldValue === numericNewValue) {
                return;
            }

            // Анимация изменения
            const duration = 800;
            const startTime = performance.now();
            element.classList.add('value-updated');

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = easeOutBack(progress);

                const currentValue = oldValue + (numericNewValue - oldValue) * easeProgress;
                element.textContent = currentValue.toFixed(2).replace('.', ',');

                // Цветовая индикация
                if (numericNewValue > oldValue) {
                    element.style.color = '#2ecc71'; 
                    element.style.textShadow = '0 0 20px rgba(46, 204, 113, 0.7)';
                } else {
                    element.style.color = '#e74c3c';
                    element.style.textShadow = '0 0 20px rgba(231, 76, 60, 0.7)';
                }

                if (progress < 1) {
                    element.style.fontWeight = '900';
                    element.style.transform = `scale(${1 + 0.1 * Math.sin(progress * Math.PI)})`;
                    requestAnimationFrame(update);
                } else {
                    setTimeout(() => {
                        element.style.color = '';
                        element.style.textShadow = '';
                        element.style.fontWeight = '';
                        element.style.transform = '';
                        element.classList.remove('value-updated');
                    }, 1500);
                }
            }

            requestAnimationFrame(update);
        }

        // Функция для плавной анимации
        function easeOutBack(t) {
            const c1 = 1.70158;
            const c3 = c1 + 1;
            return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);
        }

        function forceReconnect() {
            console.log('Принудительное переподключение...');
            isManualDisconnect = false;
            reconnectAttempts = 0;
            startSignalR();
        }

        function checkConnectionStatus() {
            if (!connection) {
                return 'Нет соединения';
            }

            switch(connection.state) {
                case signalR.HubConnectionState.Connected:
                    return 'Подключен';
                case signalR.HubConnectionState.Connecting:
                    return 'Подключение...';
                case signalR.HubConnectionState.Reconnecting:
                    return 'Переподключение...';
                case signalR.HubConnectionState.Disconnected:
                    return 'Отключен';
                default:
                    return 'Неизвестно';
            }
        }

        function initApp() {
            console.log('🚀 Инициализация приложения...');
            updateDateTime(); 
            startSignalR();   

            window.debugSignalR = {
                reconnect: forceReconnect,
                status: checkConnectionStatus,
                getOfficeId: () => officeId
            };

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && connection?.state === signalR.HubConnectionState.Disconnected) {
                    console.log('👁️ Страница снова видима, проверяем соединение...');
                    startSignalR();
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        console.log('ℹ️ Для отладки SignalR используйте:');
        console.log('  debugSignalR.reconnect() - принудительное переподключение');
        console.log('  debugSignalR.status() - статус соединения');
    </script>
}

@functions {

    string GetCurrencyName(string code)
    {
        return code switch
        {
            "USD" => "USD",
            "EUR" => "EUR",
            "CNY" => "CNY",
            "GBP" => "GBP",
            _ => code
        };
    }


}