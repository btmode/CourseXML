@model CityOffice

<!-- Просто картинка вместо div -->
<img src="/images/logo.png" class="background-logo" alt="Логотип">

<body>
    <div class="content-wrapper">
        <div class="header">
            <div class="header-left">
                <div class="bank-name">АО Тольяттихимбанк</div>
                <div class="office-text">@Model.Location</div>
            </div>
            <div class="time-card">
                <div class="time-value" id="currentDateTime">@DateTime.Now.ToString($"dd.MM.yyyy HH:mm:ss")</div>
            </div>
        </div>

        <div class="table-container">
            <!-- Таблица -->
            <table class="currency-table">
                <thead>
                    <tr>
                        <th>Валюта</th>
                        <th>Покупка</th>
                        <th>Продажа</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var currency in Model.Currencies)
                    {
                        <tr data-currency="@currency.Name">
                            <td>
                                <div class="currency-name">
                                    <div class="flag" style="background-image: url('/images/@(currency.Name).png')"></div>
                                    <span class="currency-code">@currency.Name</span>
                                </div>
                            </td>
                            <td>
                                <div class="rate-value purchase">@currency.Purchase.ToString("N2")</div>
                            </td>
                            <td>
                                <div class="rate-value sale">@currency.Sale.ToString("N2")</div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</body>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const officeId = '@Model.Id';
        let connection = null;


        //  ВРЕМЯ 
        function updateDateTime() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('currentDateTime').textContent =
                `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;

            setTimeout(updateDateTime, 1000);
        }


        // SIGNALR - ПРОСТАЯ ВЕРСИЯ
        async function startSignalR() {
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/currencyHub")
                    .withAutomaticReconnect([0, 2000, 5000, 10000, 30000])
                    .build();

                // Обработчик обновлений курсов
                connection.on("ReceiveUpdate", function(officeData) {
                    if (!officeData || !officeData.Currencies) return;

                    // Обновляем курсы валют
                    officeData.Currencies.forEach(currency => {
                        const row = document.querySelector(`tr[data-currency="${currency.Name}"]`);
                        if (row) {
                            updateCurrencyValue(row.querySelector('.purchase'), currency.Purchase);
                            updateCurrencyValue(row.querySelector('.sale'), currency.Sale);
                        }
                    });
                });

                await connection.start();
                await connection.invoke("JoinGroup", officeId);
                console.log('SignalR подключен');

            } catch (err) {
                console.error('Ошибка SignalR:', err);
                setTimeout(startSignalR, 5000);
            }
        }

        // ОБНОВЛЕНИЕ КУРСОВ С АНИМАЦИЕЙ
        function updateCurrencyValue(element, newValue) {
            if (!element) return;

            const oldValue = parseFloat(element.textContent.replace(',', '.'));
            const numericNewValue = parseFloat(newValue);

            if (isNaN(oldValue) || isNaN(numericNewValue) || oldValue === numericNewValue) {
                return;
            }

            // Анимация изменения
            const duration = 800;
            const startTime = performance.now();
            element.classList.add('value-updated');

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = easeOutBack(progress);

                const currentValue = oldValue + (numericNewValue - oldValue) * easeProgress;
                element.textContent = currentValue.toFixed(2).replace('.', ',');

                // Цветовая индикация
                if (numericNewValue > oldValue) {
                    element.style.color = '#2ecc71'; // Зеленый
                    element.style.textShadow = '0 0 20px rgba(46, 204, 113, 0.7)';
                } else {
                    element.style.color = '#e74c3c'; // Красный
                    element.style.textShadow = '0 0 20px rgba(231, 76, 60, 0.7)';
                }

                if (progress < 1) {
                    element.style.fontWeight = '900';
                    element.style.transform = `scale(${1 + 0.1 * Math.sin(progress * Math.PI)})`;
                    requestAnimationFrame(update);
                } else {
                    // Возвращаем нормальные стили через 1.5 секунды
                    setTimeout(() => {
                        element.style.color = '';
                        element.style.textShadow = '';
                        element.style.fontWeight = '';
                        element.style.transform = '';
                        element.classList.remove('value-updated');
                    }, 1500);
                }
            }

            requestAnimationFrame(update);
        }

        // Функция для плавной анимации
        function easeOutBack(t) {
            const c1 = 1.70158;
            const c3 = c1 + 1;
            return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);
        }

        function initApp() {
            updateDateTime(); // Запускаем часы
            startSignalR();   // Запускаем SignalR
        }

        // Запускаем когда страница загрузится
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
}

@functions {

    string GetCurrencyName(string code)
    {
        return code switch
        {
            "USD" => "USD",
            "EUR" => "EUR",
            "CNY" => "CNY",
            "GBP" => "GBP",
            _ => code
        };
    }


}